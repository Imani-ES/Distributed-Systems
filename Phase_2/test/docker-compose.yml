version: '3.3'
services:
  
  node_1:
    image: getting-started
    container_name: Node_1
    networks:
        - node_1
        - rainbow_bridge
    build: 
      context: .
    ports:
      - '3000:3000'
      - '8080:8080'
    environment:
      - Port=3000
      - db_name=test
      - app_name=Node_1
      #- lead=yes
      - host=Node_1
      - rainbow_bridge=8080
      - DB_connect=mongodb://root:rootpwd@mongodb_1:27017
    depends_on:
      mongodb_1:  
        condition:  service_started
      mongodb_2:
        condition:  service_started
      mongodb_3:
        condition:  service_started
  
  node_2:
    image: getting-started
    container_name: Node_2
    networks:
        - node_2
        - rainbow_bridge
    build: 
      context: .
    ports:
      - '5050:5050'
    environment:
      - Port=3000
      - db_name=test
      - app_name=Node_2
      #- lead=no
      - host=Node_1
      - rainbow_bridge=8080
      - DB_connect=mongodb://root:rootpwd@mongodb_2:27017
      - node1:http://node_1:3000
    depends_on:
      node_1:
        condition:  service_started
      mongo_2:  
        condition:  service_started

  mongo:
      image: mongo
      container_name: mongodb_1
      restart: unless-stopped
      networks:
        - node_1
      environment:
        MONGO_INITDB_DATABASE: test
        MONGO_INITDB_ROOT_USERNAME: root
        MONGO_INITDB_ROOT_PASSWORD: rootpwd
      volumes:
        - /data/mongo_1
      ports:
        - '27017:27017'
  
  mongo_2:
      image: mongo
      container_name: mongodb_2
      restart: unless-stopped
      networks:
        - node_2
      environment:
        MONGO_INITDB_DATABASE: test
        MONGO_INITDB_ROOT_USERNAME: root
        MONGO_INITDB_ROOT_PASSWORD: rootpwd
      volumes:
        - /data/mongo_2
      ports:
        - '27027:27017'

  mongo_3:
      image: mongo
      container_name: mongodb_3
      restart: unless-stopped
      networks:
        - node_2
      environment:
        MONGO_INITDB_DATABASE: test
        MONGO_INITDB_ROOT_USERNAME: root
        MONGO_INITDB_ROOT_PASSWORD: rootpwd
      volumes:
        - /data/mongo_3
      ports:
        - '27037:27017'
networks:
#rainbow bridge is the network between nodes
    rainbow_bridge:
      name: rainbow_bridge
      driver: bridge
#node networks are the networks between database and apps
    node_1:
      name: node_1
      driver: bridge
    node_2:
      name: node_2
      driver: bridge
    node_3:
      name: node_3
      driver: bridge
